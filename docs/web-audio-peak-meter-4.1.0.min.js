var webAudioPeakMeter=function(e){"use strict";const t={peakHoldDuration:0,peakCallbackDelay:"immediate"};function s(e){return 20*(t=10,s=e,Math.log(s)/Math.log(t));var t,s}return e.WebAudioPeakMeter=class{constructor(e,s,a={}){this.srcNode=e,this.peakCallback=s,this.config=Object.assign(Object.assign({},t),a),this.channelCount=e.channelCount,this.tempPeaks=new Array(this.channelCount).fill({volume:-1/0,amplitude:0}),this.heldPeaks=new Array(this.channelCount).fill({volume:-1/0,amplitude:0}),this.peakHoldIntervals=new Array(this.channelCount).fill(void 0),this.initNode().catch((e=>{console.error("WebAudioPeakMeter: Failed to initialize the AudioWorkletNode.",e)}))}async initNode(){if("closed"!==this.srcNode.context.state){try{this.node=new AudioWorkletNode(this.srcNode.context,"true-peak-processor",{parameterData:{}})}catch(e){const t=new Blob(['function t(t,s,e){const r=[];for(let o=0;o<e;o+=1){let i=0,n=0;for(let r=o;r<s.length;r+=e)n+=s[r]*t[t.length-1-i],i+=1;r.push(n)}return r}class s extends AudioWorkletProcessor{constructor(){super(),this.numCoefficients=33,this.sampleRate=sampleRate,this.upsampleFactor=this.sampleRate>8e4?2:4,this.lpfCoefficients=function(t,s){const e=[],r=1/(4*s),o=1-Math.ceil(t/2),i=Math.floor(t/2);for(let n=o;n<=i;n++){const o=.54+.46*Math.cos(2*Math.PI*n/t);let i=0;i=0==n?2*r:Math.sin(2*Math.PI*r*n)/(Math.PI*n),i=o*i*s,e.push(i)}return e}(this.numCoefficients,this.upsampleFactor),this.lpfBuffers=[],this.port.postMessage({type:"message",message:`true peak inited? ${this.sampleRate}`}),this.processCount=0}process(s){const e=s[0];if(e.length>this.lpfBuffers.length)for(let t=1;t<=e.length;t+=1)t>this.lpfBuffers.length&&this.lpfBuffers.push(new Array(this.numCoefficients).fill(0));const r=function(s,e,r,o){return s.map(((s,i)=>{const n=e[i];let a=0;for(let e=0;e<s.length;e++){const i=s[e];n.push(i),n.shift();const h=t(n,r,o);for(let t=0;t<h.length;t++){const s=Math.abs(h[t]);s>a&&(a=s)}}return a}))}(e,this.lpfBuffers,this.lpfCoefficients,this.upsampleFactor),o=function(t){return t.map((t=>{let s=0;for(let e=0;e<t.length;e++){const r=Math.abs(t[e]);r>s&&(s=r)}return s}))}(e);return this.port.postMessage({type:"peaks",volumes:r,amplitudes:o}),this.processCount%100==0&&this.port.postMessage({type:"message",message:this.lpfBuffers}),this.processCount+=1,!0}}try{registerProcessor("true-peak-processor",s)}catch(t){console.info("Failed to register true-peak-processor. This probably means it was already registered.")}\n'],{type:"application/javascript"}),s=URL.createObjectURL(t);await this.srcNode.context.audioWorklet.addModule(s),this.node=new AudioWorkletNode(this.srcNode.context,"true-peak-processor",{parameterData:{}})}if(this.node.port.onmessage=e=>this.handleNodePortMessage(e),this.srcNode.connect(this.node).connect(this.srcNode.context.destination),"requestAnimationFrame"===this.config.peakCallbackDelay&&this.peakCallback){const e=()=>{var t;null===(t=this.peakCallback)||void 0===t||t.call(null,this.getNormalizedCurrentPeakVolume()),this.animationRequestId=requestAnimationFrame(e)};this.animationRequestId=requestAnimationFrame(e)}"number"==typeof this.config.peakCallbackDelay&&this.peakCallback&&(this.intervalId=window.setInterval((()=>{var e;null===(e=this.peakCallback)||void 0===e||e.call(null,this.getNormalizedCurrentPeakVolume())}),this.config.peakCallbackDelay))}else console.warn("WebAudioPeakMeter: The AudioContext is closed, cannot initialize the node.")}handleNodePortMessage(e){if("message"===e.data.type&&console.log(e.data.message),"peaks"===e.data.type){const{volumes:t,amplitudes:s}=e.data;for(let e=0;e<this.tempPeaks.length;e+=1)t.length>e?this.tempPeaks[e]={volume:t[e],amplitude:s[e]}:this.tempPeaks[e]={volume:-1/0,amplitude:0};t.length<this.channelCount&&this.tempPeaks.fill({volume:-1/0,amplitude:0},t.length);for(let e=0;e<t.length;e+=1)(t[e]>this.heldPeaks[e].volume||s[e]>this.heldPeaks[e].amplitude)&&(this.heldPeaks[e]={volume:Math.max(this.heldPeaks[e].volume,t[e]),amplitude:Math.max(this.heldPeaks[e].amplitude,s[e])},this.peakHoldIntervals[e]&&clearInterval(this.peakHoldIntervals[e]),this.config.peakHoldDuration&&(this.peakHoldIntervals[e]=window.setInterval((()=>this.clearPeak(e)),this.config.peakHoldDuration)));"immediate"===this.config.peakCallbackDelay&&this.peakCallback&&this.peakCallback(this.getNormalizedCurrentPeakVolume())}}clearPeak(e){this.heldPeaks[e]=this.tempPeaks[e]}clearPeaks(){for(let e=0;e<this.heldPeaks.length;e+=1)this.clearPeak(e)}getPeaks(){return{current:this.tempPeaks,maxes:this.heldPeaks,currentDB:this.tempPeaks.map((({volume:e})=>s(e))),maxesDB:this.heldPeaks.map((({volume:e})=>s(e)))}}getNormalizedCurrentPeakVolume(){let{volume:e,amplitude:t}=this.tempPeaks.reduce(((e,t)=>({volume:Math.max(e.volume,s(t.volume)),amplitude:Math.max(e.amplitude,t.amplitude)})),{volume:-1/0,amplitude:0});if(this.config.peakCallbackNormalizeVolume){const{dbRangeMin:t,dbRangeMax:s,normalizedRangeMin:a,normalizedRangeMax:i}=this.config.peakCallbackNormalizeVolume,o=i-a,l=s-t;e=Math.max(t,Math.min(s,e)),e=a+(e-t)*o/l}return{volume:e,amplitude:t}}cleanup(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0),this.animationRequestId&&(cancelAnimationFrame(this.animationRequestId),this.animationRequestId=void 0);for(let e=0;e<this.peakHoldIntervals.length;++e)this.peakHoldIntervals[e]&&(clearInterval(this.peakHoldIntervals[e]),this.peakHoldIntervals[e]=void 0);if(this.clearPeaks(),this.node){try{this.srcNode.disconnect(this.node)}catch(e){}this.node.disconnect()}}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=web-audio-peak-meter-4.1.0.min.js.map
