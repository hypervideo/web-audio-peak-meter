var webAudioPeakMeter=function(e){"use strict";const t={peakHoldDuration:0,peakCallbackDelay:"immediate"};function a(e){return 20*(t=10,a=e,Math.log(a)/Math.log(t));var t,a}return e.WebAudioPeakMeter=class{constructor(e,a,s={}){this.srcNode=e,this.peakCallback=a,this.config=Object.assign(Object.assign({},t),s),this.channelCount=e.channelCount,this.tempPeaks=new Array(this.channelCount).fill({volume:-Number.MAX_VALUE,amplitude:0}),this.heldPeaks=new Array(this.channelCount).fill({volume:-Number.MAX_VALUE,amplitude:0}),this.peakHoldIntervals=new Array(this.channelCount).fill(void 0),this.initNode().catch((e=>{console.error("WebAudioPeakMeter: Failed to initialize the AudioWorkletNode.",e)}))}async initNode(){if("closed"!==this.srcNode.context.state){try{this.node=new AudioWorkletNode(this.srcNode.context,"true-peak-processor",{parameterData:{}})}catch(e){const t=new Blob(['function t(t,e,s){const r=[];for(let o=0;o<s;o+=1){let n=0,l=0;for(let r=o;r<e.length;r+=s)l+=e[r]*t[t.length-1-n],n+=1;r.push(l)}return r}class e extends AudioWorkletProcessor{constructor(){super(),this.numCoefficients=33,this.sampleRate=sampleRate,this.upsampleFactor=this.sampleRate>8e4?2:4,this.lpfCoefficients=function(t,e){const s=[],r=1/(4*e),o=1-Math.ceil(t/2),n=Math.floor(t/2);for(let l=o;l<=n;l++){const o=.54+.46*Math.cos(2*Math.PI*l/t);let n=0;n=0==l?2*r:Math.sin(2*Math.PI*r*l)/(Math.PI*l),n=o*n*e,s.push(n)}return s}(this.numCoefficients,this.upsampleFactor),this.lpfBuffers=[]}process(e){const s=e[0];if(s.length>this.lpfBuffers.length)for(let t=1;t<=s.length;t+=1)t>this.lpfBuffers.length&&this.lpfBuffers.push(new Array(this.numCoefficients).fill(0));const r=function(e,s,r,o){return e.map(((e,n)=>{const l=s[n];let i=0;for(let s=0;s<e.length;s++){const n=e[s];l.push(n),l.shift();const f=t(l,r,o);for(let t=0;t<f.length;t++){const e=Math.abs(f[t]);e>i&&(i=e)}}return i}))}(s,this.lpfBuffers,this.lpfCoefficients,this.upsampleFactor),o=function(t){return t.map((t=>{let e=0;for(let s=0;s<t.length;s++){const r=Math.abs(t[s]);r>e&&(e=r)}return e}))}(s);return this.port.postMessage({type:"peaks",volumes:r,amplitudes:o}),!0}}try{registerProcessor("true-peak-processor",e)}catch(t){console.info("Failed to register true-peak-processor. This probably means it was already registered.")}\n'],{type:"application/javascript"}),a=URL.createObjectURL(t);await this.srcNode.context.audioWorklet.addModule(a),this.node=new AudioWorkletNode(this.srcNode.context,"true-peak-processor",{parameterData:{}})}if(this.node.port.onmessage=e=>this.handleNodePortMessage(e),this.srcNode.connect(this.node).connect(this.srcNode.context.destination),"requestAnimationFrame"===this.config.peakCallbackDelay&&this.peakCallback){const e=()=>{var t;null===(t=this.peakCallback)||void 0===t||t.call(null,this.getNormalizedCurrentPeakVolume()),this.animationRequestId=requestAnimationFrame(e)};this.animationRequestId=requestAnimationFrame(e)}"number"==typeof this.config.peakCallbackDelay&&this.peakCallback&&(this.intervalId=window.setInterval((()=>{var e;null===(e=this.peakCallback)||void 0===e||e.call(null,this.getNormalizedCurrentPeakVolume())}),this.config.peakCallbackDelay))}else console.warn("WebAudioPeakMeter: The AudioContext is closed, cannot initialize the node.")}handleNodePortMessage(e){if("message"===e.data.type&&console.log(e.data.message),"peaks"===e.data.type){const{volumes:t,amplitudes:a}=e.data;for(let e=0;e<this.tempPeaks.length;e+=1)t.length>e?this.tempPeaks[e]={volume:t[e],amplitude:a[e]}:this.tempPeaks[e]={volume:-Number.MAX_VALUE,amplitude:0};t.length<this.channelCount&&this.tempPeaks.fill({volume:-Number.MAX_VALUE,amplitude:0},t.length);for(let e=0;e<t.length;e+=1)(t[e]>this.heldPeaks[e].volume||a[e]>this.heldPeaks[e].amplitude)&&(this.heldPeaks[e]={volume:Math.max(this.heldPeaks[e].volume,t[e]),amplitude:Math.max(this.heldPeaks[e].amplitude,a[e])},this.peakHoldIntervals[e]&&clearInterval(this.peakHoldIntervals[e]),this.config.peakHoldDuration&&(this.peakHoldIntervals[e]=window.setInterval((()=>this.clearPeak(e)),this.config.peakHoldDuration)));"immediate"===this.config.peakCallbackDelay&&this.peakCallback&&this.peakCallback(this.getNormalizedCurrentPeakVolume())}}clearPeak(e){this.heldPeaks[e]=this.tempPeaks[e]}clearPeaks(){for(let e=0;e<this.heldPeaks.length;e+=1)this.clearPeak(e)}getPeaks(){return{current:this.tempPeaks,maxes:this.heldPeaks,currentDB:this.tempPeaks.map((({volume:e})=>a(e))),maxesDB:this.heldPeaks.map((({volume:e})=>a(e)))}}getNormalizedCurrentPeakVolume(){let{volume:e,amplitude:t}=this.heldPeaks.reduce(((e,t)=>({volume:Math.max(e.volume,a(t.volume)),amplitude:Math.max(e.amplitude,t.amplitude)})),{volume:-Number.MAX_VALUE,amplitude:0});if(this.config.peakCallbackNormalizeVolume){const{dbRangeMin:t,dbRangeMax:a,normalizedRangeMin:s,normalizedRangeMax:l}=this.config.peakCallbackNormalizeVolume,i=l-s,o=a-t;e=Math.max(t,Math.min(a,e)),e=s+(e-t)*i/o}return{volume:e,amplitude:t}}cleanup(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0),this.animationRequestId&&(cancelAnimationFrame(this.animationRequestId),this.animationRequestId=void 0);for(let e=0;e<this.peakHoldIntervals.length;++e)this.peakHoldIntervals[e]&&(clearInterval(this.peakHoldIntervals[e]),this.peakHoldIntervals[e]=void 0);if(this.clearPeaks(),this.node){try{this.srcNode.disconnect(this.node)}catch(e){}this.node.disconnect()}}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=web-audio-peak-meter-5.0.4.min.js.map
