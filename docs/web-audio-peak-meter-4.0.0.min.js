var webAudioPeakMeter=function(e){"use strict";const t={audioMeterStandard:"peak-sample",peakHoldDuration:0,peakCallbackDelay:"immediate"};function s(e){return 20*(t=10,s=e,Math.log(s)/Math.log(t));var t,s}return e.WebAudioPeakMeter=class{constructor(e,s,a={}){this.srcNode=e,this.peakCallback=s,this.config=Object.assign(Object.assign({},t),a),this.channelCount=e.channelCount,this.tempPeaks=new Array(this.channelCount).fill(0),this.heldPeaks=new Array(this.channelCount).fill(0),this.peakHoldTimeouts=new Array(this.channelCount).fill(0),this.initNode()}async initNode(){if("closed"===this.srcNode.context.state)return void console.warn("WebAudioPeakMeter: The AudioContext is closed, cannot initialize the node.");const{audioMeterStandard:e}=this.config;try{this.node=new AudioWorkletNode(this.srcNode.context,`${e}-processor`,{parameterData:{}})}catch(t){const s=new Blob(["true-peak"===e?'function s(s,t,e){const o=[];for(let r=0;r<e;r+=1){let i=0,n=0;for(let o=r;o<t.length;o+=e)n+=t[o]*s[s.length-1-i],i+=1;o.push(n)}return o}class t extends AudioWorkletProcessor{constructor(){super(),this.numCoefficients=33,this.sampleRate=sampleRate,this.upsampleFactor=this.sampleRate>8e4?2:4,this.lpfCoefficients=function(s,t){const e=[],o=1/(4*t),r=1-Math.ceil(s/2),i=Math.floor(s/2);for(let n=r;n<=i;n++){const r=.54+.46*Math.cos(2*Math.PI*n/s);let i=0;i=0==n?2*o:Math.sin(2*Math.PI*o*n)/(Math.PI*n),i=r*i*t,e.push(i)}return e}(this.numCoefficients,this.upsampleFactor),this.lpfBuffers=[],this.port.postMessage({type:"message",message:`true peak inited? ${this.sampleRate}`}),this.processCount=0}process(t){const e=t[0];if(e.length>this.lpfBuffers.length)for(let s=1;s<=e.length;s+=1)s>this.lpfBuffers.length&&this.lpfBuffers.push(new Array(this.numCoefficients).fill(0));const o=function(t,e,o,r){return t.map(((t,i)=>{const n=e[i];let h=0;for(let e=0;e<t.length;e++){const i=t[e];n.push(i),n.shift();const a=s(n,o,r);for(let s=0;s<a.length;s++){const t=Math.abs(a[s]);t>h&&(h=t)}}return h}))}(e,this.lpfBuffers,this.lpfCoefficients,this.upsampleFactor);return this.port.postMessage({type:"peaks",peaks:o}),this.processCount%100==0&&this.port.postMessage({type:"message",message:this.lpfBuffers}),this.processCount+=1,!0}}try{registerProcessor("true-peak-processor",t)}catch(s){console.info("Failed to register true-peak-processor. This probably means it was already registered.")}\n':'class e extends AudioWorkletProcessor{process(e){const s=function(e){return e.map((e=>{let s=0;for(let r=0;r<e.length;r++){const t=Math.abs(e[r]);t>s&&(s=t)}return s}))}(e[0]);return this.port.postMessage({type:"peaks",peaks:s}),!0}}try{registerProcessor("peak-sample-processor",e)}catch(e){console.info("Failed to register peak-sample-processor. This probably means it was already registered.")}\n'],{type:"application/javascript"}),a=URL.createObjectURL(s);await this.srcNode.context.audioWorklet.addModule(a),this.node=new AudioWorkletNode(this.srcNode.context,`${e}-processor`,{parameterData:{}})}if(this.node.port.onmessage=e=>this.handleNodePortMessage(e),this.srcNode.connect(this.node).connect(this.srcNode.context.destination),"requestAnimationFrame"===this.config.peakCallbackDelay&&this.peakCallback){const e=()=>{var t;null===(t=this.peakCallback)||void 0===t||t.call(null,this.getNormalizedCurrentPeakVolume()),this.animationRequestId=requestAnimationFrame(e)};this.animationRequestId=requestAnimationFrame(e)}"number"==typeof this.config.peakCallbackDelay&&this.peakCallback&&(this.intervalId=window.setInterval((()=>{var e;null===(e=this.peakCallback)||void 0===e||e.call(null,this.getNormalizedCurrentPeakVolume())}),this.config.peakCallbackDelay))}handleNodePortMessage(e){if("message"===e.data.type&&console.log(e.data.message),"peaks"===e.data.type){const{peaks:t}=e.data;for(let e=0;e<this.tempPeaks.length;e+=1)t.length>e?this.tempPeaks[e]=t[e]:this.tempPeaks[e]=0;t.length<this.channelCount&&this.tempPeaks.fill(0,t.length);for(let e=0;e<t.length;e+=1)t[e]>this.heldPeaks[e]&&(this.heldPeaks[e]=t[e],this.peakHoldTimeouts[e]&&clearTimeout(this.peakHoldTimeouts[e]),this.config.peakHoldDuration&&(this.peakHoldTimeouts[e]=window.setTimeout((()=>{this.clearPeak(e)}),this.config.peakHoldDuration)));"immediate"===this.config.peakCallbackDelay&&this.peakCallback&&this.peakCallback(this.getNormalizedCurrentPeakVolume())}}clearPeak(e){this.heldPeaks[e]=this.tempPeaks[e]}clearPeaks(){for(let e=0;e<this.heldPeaks.length;e+=1)this.clearPeak(e)}getPeaks(){return{current:this.tempPeaks,maxes:this.heldPeaks,currentDB:this.tempPeaks.map(s),maxesDB:this.heldPeaks.map(s)}}getNormalizedCurrentPeakVolume(){let e=s(Math.max(...this.tempPeaks));if(this.config.peakCallbackNormalizeVolume){const{dbRangeMin:t,dbRangeMax:s,normalizedRangeMin:a,normalizedRangeMax:i}=this.config.peakCallbackNormalizeVolume,o=i-a,n=s-t;e=Math.max(t,Math.min(s,e)),e=a+(e-t)*o/n}return e}cleanup(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0),this.animationRequestId&&(cancelAnimationFrame(this.animationRequestId),this.animationRequestId=void 0),this.clearPeaks(),this.node&&this.node.disconnect()}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=web-audio-peak-meter-4.0.0.min.js.map
